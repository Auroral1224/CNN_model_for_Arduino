#include <EloquentTinyML.h>
#include <eloquent_tinyml/tensorflow.h>

// model.h contains the array you exported from Python with xxd or tinymlgen
#include "pruned_model.h"

#define N_INPUTS 28*28
#define N_OUTPUTS 10
// in future projects you may need to tweak this value: it's a trial and error process
#define TENSOR_ARENA_SIZE 102400

Eloquent::TinyML::TensorFlow::TensorFlow<N_INPUTS, N_OUTPUTS, TENSOR_ARENA_SIZE> tf;

void setup() {
    Serial.begin(115200);
    delay(4000);
    tf.begin(digits_model);

    // check if model loaded fine
    if (!tf.isOk()) {
      Serial.print("ERROR: ");
      Serial.println(tf.getErrorMessage());

      while (true) delay(1000);
    }
    else
      Serial.print("Tensorflow model loaded. Inferencing...\n");
}

void loop() {
      
    float x_test[28*28] = {0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.003921569, 0.003921569, 0.003921569, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.003921569, 0.007843138, 0.007843138, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.003921569, 0.007843138, 0.011764706, 0.011764706, 0.015686275, 0.011764706, 0.011764706, 0.007843138, 0.003921569, 0.003921569, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.007843138, 0.086274512, 0.094117649, 0.031372551, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.003921569, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.003921569, 0.000000000, 0.188235298, 0.274509817, 0.364705890, 0.705882370, 0.784313738, 0.803921580, 0.756862760, 0.670588255, 0.607843161, 0.572549045, 0.470588237, 0.376470596, 0.286274523, 0.215686277, 0.160784319, 0.094117649, 0.015686275, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.011764706, 0.000000000, 0.368627459, 0.878431380, 0.807843149, 0.800000012, 0.862745106, 0.870588243, 0.882352948, 0.898039222, 0.890196085, 0.886274517, 0.890196085, 0.886274517, 0.874509811, 0.862745106, 0.850980401, 0.823529422, 0.698039234, 0.219607845, 0.000000000, 0.003921569, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.011764706, 0.000000000, 0.447058827, 0.894117653, 0.701960802, 0.129411772, 0.219607845, 0.364705890, 0.537254930, 0.662745118, 0.733333349, 0.784313738, 0.823529422, 0.854901969, 0.862745106, 0.862745106, 0.862745106, 0.886274517, 0.764705896, 0.274509817, 0.000000000, 0.003921569, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.007843138, 0.000000000, 0.513725519, 0.858823538, 0.811764717, 0.137254909, 0.015686275, 0.000000000, 0.000000000, 0.031372551, 0.074509807, 0.098039217, 0.160784319, 0.286274523, 0.427450985, 0.486274511, 0.556862772, 0.670588255, 0.490196079, 0.078431375, 0.000000000, 0.003921569, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.007843138, 0.000000000, 0.560784340, 0.850980401, 0.882352948, 0.835294127, 0.792156875, 0.725490212, 0.733333349, 0.717647076, 0.690196097, 0.607843161, 0.458823532, 0.172549024, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.015686275, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.007843138, 0.000000000, 0.317647070, 0.823529422, 0.870588243, 0.866666675, 0.866666675, 0.874509811, 0.874509811, 0.874509811, 0.886274517, 0.890196085, 0.901960790, 0.901960790, 0.607843161, 0.058823530, 0.007843138, 0.003921569, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.003921569, 0.000000000, 0.200000003, 0.478431374, 0.545098066, 0.611764729, 0.674509823, 0.694117665, 0.705882370, 0.721568644, 0.800000012, 0.850980401, 0.835294127, 0.933333337, 0.635294139, 0.015686275, 0.011764706, 0.003921569, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.003921569, 0.003921569, 0.003921569, 0.000000000, 0.003921569, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.019607844, 0.023529412, 0.027450981, 0.058823530, 0.149019614, 0.447058827, 0.847058833, 0.839215696, 0.952941179, 0.392156869, 0.000000000, 0.011764706, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.007843138, 0.011764706, 0.007843138, 0.003921569, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.509803951, 0.886274517, 0.858823538, 0.858823538, 0.117647059, 0.003921569, 0.007843138, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.007843138, 0.074509807, 0.168627456, 0.207843140, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.003921569, 0.003921569, 0.003921569, 0.003921569, 0.011764706, 0.011764706, 0.054901961, 0.733333349, 0.858823538, 0.925490201, 0.545098066, 0.000000000, 0.011764706, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.070588239, 0.580392182, 0.686274529, 0.827450991, 0.164705887, 0.000000000, 0.007843138, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.011764706, 0.000000000, 0.341176480, 0.890196085, 0.858823538, 0.905882359, 0.184313729, 0.000000000, 0.011764706, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.039215688, 0.811764717, 0.858823538, 0.937254906, 0.317647070, 0.003921569, 0.015686275, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.003921569, 0.007843138, 0.023529412, 0.682352960, 0.886274517, 0.960784316, 0.615686297, 0.000000000, 0.007843138, 0.000000000, 0.000000000, 0.000000000, 0.007843138, 0.000000000, 0.694117665, 0.878431380, 0.905882359, 0.552941203, 0.000000000, 0.011764706, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.011764706, 0.000000000, 0.290196091, 0.882352948, 0.898039222, 0.882352948, 0.176470593, 0.000000000, 0.011764706, 0.000000000, 0.000000000, 0.015686275, 0.000000000, 0.419607848, 0.937254906, 0.874509811, 0.839215696, 0.019607844, 0.003921569, 0.007843138, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.003921569, 0.003921569, 0.019607844, 0.713725507, 0.905882359, 0.917647064, 0.584313750, 0.000000000, 0.007843138, 0.000000000, 0.000000000, 0.007843138, 0.000000000, 0.125490203, 0.909803927, 0.862745106, 0.941176474, 0.486274511, 0.000000000, 0.000000000, 0.015686275, 0.007843138, 0.007843138, 0.007843138, 0.007843138, 0.011764706, 0.011764706, 0.015686275, 0.011764706, 0.019607844, 0.000000000, 0.282352954, 0.894117653, 0.909803927, 0.807843149, 0.054901961, 0.000000000, 0.003921569, 0.000000000, 0.000000000, 0.011764706, 0.000000000, 0.560784340, 0.988235295, 0.847058833, 0.941176474, 0.556862772, 0.086274512, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.266666681, 0.886274517, 0.905882359, 0.874509811, 0.113725491, 0.000000000, 0.003921569, 0.000000000, 0.000000000, 0.003921569, 0.007843138, 0.058823530, 0.733333349, 0.972549021, 0.866666675, 0.941176474, 0.815686285, 0.478431374, 0.215686277, 0.184313729, 0.180392161, 0.152941182, 0.223529413, 0.270588249, 0.384313732, 0.568627477, 0.690196097, 0.721568644, 0.882352948, 0.890196085, 0.925490201, 0.854901969, 0.062745102, 0.000000000, 0.003921569, 0.000000000, 0.000000000, 0.000000000, 0.003921569, 0.000000000, 0.043137256, 0.623529434, 0.960784316, 0.929411769, 0.909803927, 0.941176474, 0.909803927, 0.901960790, 0.917647064, 0.909803927, 0.921568632, 0.937254906, 0.964705884, 0.984313726, 0.972549021, 0.964705884, 0.945098042, 0.956862748, 0.949019611, 0.396078438, 0.000000000, 0.007843138, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.003921569, 0.000000000, 0.000000000, 0.298039228, 0.764705896, 0.949019611, 0.960784316, 0.972549021, 0.992156863, 0.992156863, 0.988235295, 0.972549021, 0.988235295, 0.992156863, 0.980392158, 0.937254906, 0.894117653, 0.807843149, 0.552941203, 0.219607845, 0.000000000, 0.003921569, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.003921569, 0.007843138, 0.000000000, 0.000000000, 0.250980407, 0.533333361, 0.662745118, 0.678431392, 0.670588255, 0.674509823, 0.647058845, 0.560784340, 0.509803951, 0.356862754, 0.200000003, 0.121568628, 0.031372551, 0.000000000, 0.000000000, 0.007843138, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.011764706, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.011764706, 0.007843138, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.011764706, 0.015686275, 0.011764706, 0.007843138, 0.011764706, 0.007843138, 0.011764706, 0.015686275, 0.015686275, 0.015686275, 0.007843138, 0.007843138, 0.003921569, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000, 0.000000000};
    int   y_test = 5;
    float y_pred[10] = {0};

    uint32_t start = micros();

    tf.predict(x_test, y_pred);

    uint32_t timeit = micros() - start;

    Serial.print("It took ");
    Serial.print(timeit);
    Serial.print(" micros to run inference.\n");

    Serial.print("The input is : ");
    Serial.print(y_test);
    Serial.print("\nPredicted probabilities are: \n");

    for (int i = 0; i < 10; i++) {
        Serial.print(i);
        Serial.print(" : ");
        Serial.print(y_pred[i]);
        Serial.print('\n');
    }

    Serial.print("Predicted class is: ");
    Serial.print(tf.probaToClass(y_pred));
    Serial.print("\nSanity check: ");
    Serial.print(tf.predictClass(x_test));

    Serial.print("\nInference ended.");
    while (true) delay(10000);
}
